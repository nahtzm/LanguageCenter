{% extends "/layout/dashboard_base.html" %}
{% block title %}Điểm danh{% endblock %}

{% block dashboard_content %}
  <div class="flex h-screen bg-base-200">
    <!-- Main content -->
    <div class="flex-1 p-8 overflow-y-auto">
      <h1 class="text-3xl font-bold mb-8">
        ĐIỂM DANH
        <span>
          – Ngày {{ session_date.strftime("%d/%m/%Y") if session_date.__class__.__name__ != 'str' else session_date }}
        </span>
      </h1>

      <!-- Form chọn lớp và ngày -->
      <form method="GET" class="flex flex-col md:flex-row gap-4 mb-8">
        <div class="flex-1">
          <label class="label">
            <span class="label-text font-medium">Lớp</span>
          </label>
          <select name="class_id" class="select select-bordered w-full" onchange="this.form.submit()">
            <option disabled selected>Chọn lớp</option>
            {% for class_obj in current_user.taught_classes %}
              <option value="{{ class_obj.id }}"
                      {% if selected_class and selected_class.id == class_obj.id %}selected{% endif %}>
                {{ class_obj.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="flex-1">
          <label class="label">
            <span class="label-text font-medium">Ngày</span>
          </label>
          <input type="date" name="session_date" value="{{ session_date }}"
                 class="input input-bordered w-full" required/>
        </div>

        <div class="flex items-end">
          <button type="submit" class="btn btn-neutral">Xem</button>
        </div>
      </form>

      <!-- Bảng điểm danh -->
      {% if selected_class and enrollments %}
        <form method="POST">
          <div class="overflow-x-auto shadow-lg rounded-lg bg-base-100">
            <table class="table table-zebra">
              <thead>
                <tr class="bg-base-300">
                  <th class="text-center">Mã học viên</th>
                  <th>Họ tên</th>
                  <th class="text-center">Điểm danh</th>
                </tr>
              </thead>
              <tbody>
                {% for enrollment in enrollments %}
                  {% set student = enrollment.student %}
                  {% set is_present = attendance_map[enrollment.id] %}
                  <tr>
                    <td class="text-center font-medium">{{ student.code }}</td>
                    <td class="font-medium">{{ student.fullname }}</td>
                    <td class="text-center">
                      <div class="flex justify-center gap-8">
                        <label class="label cursor-pointer">
                          <span class="label-text mr-3">Có mặt</span>
                          <input type="radio" name="attendance_{{ enrollment.id }}"
                                 value="present" class="radio radio-success"
                                 {% if is_present %}checked{% endif %}>
                        </label>
                        <label class="label cursor-pointer">
                          <span class="label-text mr-3">Vắng</span>
                          <input type="radio" name="attendance_{{ enrollment.id }}"
                                 value="absent" class="radio radio-error"
                                 {% if not is_present %}checked{% endif %}>
                        </label>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="flex justify-end mt-8">
            <button type="submit" class="btn btn-primary btn-lg px-10">Lưu</button>
          </div>
        </form>
      {% else %}
        <div class="alert alert-info shadow-lg mt-8">
          <span>Chọn lớp và ngày để điểm danh học viên.</span>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}